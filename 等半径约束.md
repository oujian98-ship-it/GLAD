# 等半径约束

它不强求生成的特征分布形状（椭球体的长轴短轴方向）与真实分布完全一致，而是强求生成特征的**分布紧凑度（即平均离散程度）**与真实特征一致。

以下是具体的逻辑和公式详解：

### 1. 核心公式

根据截图中的公式 (b)：

$$ \mathcal{L}_{rad} = \mathbb{E} \left[ \left( \| \tilde{z}_0 - \mu_y \|_2 - r_y \right)^2 \right] $$

其中：
*   **$\tilde{z}_0$**：**估算的特征 (Estimated Feature)**。在扩散模型中，这通常指从当前噪声 $x_t$ 预测出来的干净特征 $\hat{x}_0$（或者叫 estimated start）。
*   **$\mu_y$**：**类别中心 (Class Prototype)**。属于类别 $y$ 的真实特征的均值向量。
*   **$\|\cdot\|_2$**：**欧几里得范数 (L2 Norm)**。即特征向量到类中心的直线距离。
*   **$r_y$**：**目标半径 (Target Radius)**。这是一个标量，代表该类别特征分布的“平均大小”。

---

### 2. 目标半径 $r_y$ 的定义与计算

截图中提到：
$$ r_y \propto \sqrt{\text{tr}(\Sigma_y)} $$

这个公式的物理含义非常关键：

1.  **$\Sigma_y$ (协方差矩阵)**：描述了类别 $y$ 的真实特征在各个维度上的离散程度。
2.  **$\text{tr}(\Sigma_y)$ (迹, Trace)**：
    *   数学定义：矩阵主对角线元素之和。
    *   几何含义：**所有维度的方差之和**。它代表了数据分布的**总能量**或**总体积**。
    *   也就是说，$\text{tr}(\Sigma_y) = \mathbb{E}[\|z_{real} - \mu_y\|^2]$（真实样本到中心距离的平方期望）。
3.  **$\sqrt{\text{tr}(\Sigma_y)}$**：
    *   对总方差开根号，将其还原为“距离”或“标准差”的量纲。
    *   因此，$r_y$ 本质上就是**真实样本到类中心的平均距离（Root Mean Square Distance）**。

**具体实现逻辑：**
你不需要真的去算协方差矩阵求迹（那样又回到了样本不足的问题）。你只需要直接计算真实样本到中心的距离即可。

$$ r_y \approx \frac{1}{N} \sum_{i=1}^{N} \| z_{real}^{(i)} - \mu_y \|_2 $$

*(或者使用均方根距离，取决于具体实现，通常直接用平均距离也就是L1距离足够有效且稳定)*

---

### 3. 具体实现步骤

在代码中，这个约束分为两步走：**统计真实分布** 和 **约束生成分布**。

#### 第一步：统计阶段 (使用真实数据 Real Features)
目的是算出“尺子”的标准长度。
1.  对于每个类别 $y$，收集真实样本特征 $z_{real}$。
2.  计算均值 $\mu_y$（即类原型）。
3.  计算所有真实样本 $z_{real}$ 到 $\mu_y$ 的平均距离。
4.  将这个平均距离存为 $r_y$。

#### 第二步：约束阶段 (使用扩散模型生成的 $\tilde{z}_0$)
目的是让生成的特征符合这个“尺子”的长度。
1.  扩散模型在去噪过程中，预测出干净特征 $\tilde{z}_0$。
2.  计算 $\tilde{z}_0$ 到对应类中心 $\mu_y$ 的实际距离 $d = \|\tilde{z}_0 - \mu_y\|_2$。
3.  **计算 Loss**：让实际距离 $d$ 逼近目标半径 $r_y$。
    $$ Loss = (d - r_y)^2 $$

